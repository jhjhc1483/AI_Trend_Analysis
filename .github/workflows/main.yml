name: Run Python Script and Commit

# ğŸ’¡ ì‹¤í–‰ ì£¼ê¸° ì„¤ì •: í•œêµ­ ì‹œê°„ 06:05ì— ì‹¤í–‰ë˜ë„ë¡ UTC 21:00 ì˜ˆì•½ í›„ 5ë¶„ ëŒ€ê¸°
on:
  schedule:
    # UTC 21:00 = KST 06:00. 5ë¶„ ëŒ€ê¸° í›„ 06:05ì— ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.
    - cron: '00 21 * * *'
  # ğŸ’¡ ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ ì„¤ì • (Actions íƒ­ì—ì„œ Run workflow ë²„íŠ¼ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥)
  workflow_dispatch:

jobs:
  run-script:
    # ğŸ’¡ ìˆ˜ì •: GitHub ì œê³µ ëŸ¬ë„ˆ(ubuntu-latest) ëŒ€ì‹  Self-hosted Runner ì‚¬ìš©
    #runs-on: self-hosted
    runs-on: ubuntu-latest
    
    steps:
      # 0. ë”œë ˆì´ ì™„í™”ë¥¼ ìœ„í•œ ëŒ€ê¸° (5ë¶„ ëŒ€ê¸° í›„ ëª©í‘œ ì‹œê°„ì¸ 06:05 KSTì— ê°€ê¹ê²Œ ì‹¤í–‰)
      # ì¡°ê±´: ì›Œí¬í”Œë¡œìš°ê°€ 'schedule' ì´ë²¤íŠ¸ë¡œ ì‹¤í–‰ë˜ì—ˆì„ ë•Œë§Œ ì´ ë‹¨ê³„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Wait for 5 minutes to align with target time (06:05 KST)
        if: github.event_name == 'schedule'
        run: |
          echo "Scheduled run detected. Waiting 5 minutes (300 seconds) for time alignment."
          sleep 300s
          
        
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ (ì½”ë“œ ê°€ì ¸ì˜¤ê¸°)
      - name: Checkout code
        uses: actions/checkout@v4
        # ğŸ’¡ í† í° ì„¤ì •: ê²°ê³¼ë¥¼ ì»¤ë°‹í•˜ê¸° ìœ„í•´ í•„ìš” (permissions ì„¤ì • ê¶Œì¥)
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. Python í™˜ê²½ ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # ì›í•˜ëŠ” íŒŒì´ì¬ ë²„ì „ ì§€ì • (ì˜ˆ: '3.10')

      # ğŸ’¡ ìˆ˜ì •ëœ ì›Œí¬í”Œë¡œìš° YAML (jobs: run-script: steps ë‚´ë¶€)

      # â­ ìˆ˜ì •ëœ ë‹¨ê³„: Seleniumì„ ìœ„í•œ ì‹œìŠ¤í…œ ì¢…ì†ì„± ì„¤ì¹˜ â­
      - name: Install system dependencies for Chromium/Selenium
        run: |
          # updateëŠ” ì´ë¯¸ ë¡œê·¸ì—ì„œ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
          # sudo apt-get update
          
          # 24.04 í™˜ê²½ì— ë§ê²Œ íŒ¨í‚¤ì§€ ëª©ë¡ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.
          # 1. libasound2 -> libasound2t64ë¡œ ë³€ê²½
          # 2. libgconf-2-4 ì œê±° (ì°¾ì„ ìˆ˜ ì—†ëŠ” íŒ¨í‚¤ì§€)
          # 3. chromium-browser ëŒ€ì‹  chromium ì„¤ì¹˜ ì‹œë„
          sudo apt-get install -y \
            chromium \
            libnss3 \
            libasound2t64 \
            libatk1.0-0 \
            libgtk-3-0

      # 3. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - name: Install dependencies (including selenium, webdriver-manager)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 4. Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (aitimes.py ì¶”ê°€)
      - name: Run NIA.py script
        run: python codes/pycode/NIA.py
        
      # â­ ì¶”ê°€ëœ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë‹¨ê³„ â­
      - name: Run aitimes.py script
        run: python codes/pycode/aitimes.py
        
      - name: List files in codes directory
        run: |
          echo "--- Files in codes/ after running scripts ---"
          ls -l codes/
          echo "---------------------------------------------"
          
      # 5. ë³€ê²½ëœ íŒŒì¼ ì»¤ë°‹ ë° í‘¸ì‹œ
      # ğŸ’¡ ë§Œì•½ aitimes.pyë„ ì»¤ë°‹í•  íŒŒì¼ì´ ìˆë‹¤ë©´ file_patternì„ ì¡°ì •í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # ë§Œì•½ aitimes.pyê°€ codes/aitimes.json ê°™ì€ ë‹¤ë¥¸ íŒŒì¼ì„ ìƒì„±í•œë‹¤ë©´ íŒ¨í„´ì„ 'codes/*' ë“±ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
          file_pattern: 'codes/nia.json'
          commit_message: 'Automated data update [skip ci]' # ì»¤ë°‹ ë©”ì‹œì§€ ìˆ˜ì •
          branch: main # ë˜ëŠ” master (ì‚¬ìš©í•˜ëŠ” ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ ë³€ê²½)
